
# How to connect remotely through an SSH tunnel from my Local Machine to a DocumentDB cluster or another AWS service with VPC (Private Network) for any client?
<br />
<div align="center">
  <img align="center" alt="Ilustrator SSH - DocDB Connection" src="https://d2908q01vomqb2.cloudfront.net/887309d048beef83ad3eabf2a79a64a389ab1c9f/2020/04/06/Getting-started-part-1-A.jpg" />
</div>
<br />
<p>

- The basic need is that we must create an SSH connection or tunnel from our local machine to our database located in the DocumentDB Amazon cluster that is inside a VPC (Private Network).

- The solution is the connection to a BastionHostname or EC2 instance within the same VPC (Private Network) where the DocumentDB AWS cluster is located, adjusting its security group to map the public IP
from our local machine.
</p>
<br />
<h2>Tools:</h2>
<div>
  <ul>
  <li type="disc">OpenSSL</li>
  <li type="disc">MongoDB</li>
  <li type="disc">AWS DocumentDB Cluster</li>
  </ul>
</div>
<h2>Steps:</h2>
<p>
1. At this point it varies depending on what you are using as a local machine, for example, in the case of Windows, you must download OpenSSL, it can be from the conventional download or through the PowerShell console,
    If you are using macOS or Linux as your local machine, open the terminal and proceed with the OpenSSL installation to start the connection process.
  
 <ul>
<li> You can carry out the process of installing and configuring the operating systems at this url: https://blog.devolutions.net/2020/09/tutorial-manually-installing-openssl-on-windows-linux-macos/ </li>
  </ul>
</p>
<p>
2. The next step would be the execution of the SSH tunnel. Two things are necessary:
<ul>
<li>The Public IP of the local Machine must be registered in the security group that has the VPC (Private Network) of the DocumentDB cluster or another AWS service with port 22, the default port for SSH connections.</li>
<li>The key or the .pem file must have the necessary permissions to authenticate and connect successfully, in this case only read permissions.</li>
<li>We open the console and execute the following SSH command that allows us to establish the tunnel:</li>
</ul>
<h3 align="center">
ssh -i 'xxxxxxx.pem' -L 2701X:xxxxxxxxxx.cluster-xxxxxxx.us-east-2.docdb.amazonaws.com:27017 ubuntu@ec2-xx-xx-xx-xx.compute-1.amazonaws.com -N
</h3>
 
 <h4>SSH parameters:</h4>
  <ul>

<li><b>i:</b> The -i parameter indicates whether ssh-keygen or .pem is required to access an existing key, this option designates the file.</li>
<li><b>xxxxxxx.pem:</b> Key or key generated by the Server (BastionHostname or EC2) from the Security Group Associated with the VPC (Private Network) of the DocumentDB cluster.</li>
<li><b>L:</b> The -L parameter is used to forward a local port.</li>
<li><b>2701X:</b> Port defined by the client or end-user that can be modified, it is indicated that it must be different from the port in which the mongodb runs locally.</li>
<li><b>xxxxxxxxxx.cluster-xxxxxxx.us-east-2.docdb.amazonaws.com:27017:</b> Name of the remote DocumentDB database and its respective port to which we are going to connect.</li>
<li><b>ubuntu:</b> Server User (BastionHostname or EC2) responsible for linking.</li>
<li><b>@ec2-xx-xx-xx-xx.compute-1.amazonaws.com:</b> IP or DNS of the Server (BastionHostname or EC2) in charge of being the link between the VPC (Private Network) and the DocumentDB service.</li>
<li><b>N:</b> The parameter -N Provides a new password for the key, this process is carried out each time the access is made through the .pem.</li>
  </ul>
</p>
<p>
3. After launching the previous command, no connection notification is shown, so we must validate the creation of the SSH tunnel to the assigned port, opening another console with the command:
<ul>
  <li> PowerShell (Windows): <b> netstat â€“ab </b></li>
  <li> Bash ( MacOS - Linux): <b> lsof -iTCP -sTCP:LISTEN -n -P </b> </li>
</ul>
</p>
<p>
4. Once the SSH tunnel is created, any commands you issue to localhost:2701X are forwarded to the DocumentDB cluster running in the VPC (Private Network). Yes Transport Layer Security (TLS)
    is enabled in the DocumentDB cluster, you must download the public key for Amazon DocumentDB, open the console and execute the following command:

  <h4 align="center">
wget https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem
</h4>


</p>
<p>
5. Finally, we execute the following command in the console, which is the point-to-point connection between our local machine and the database that we have in the DocumentDB AWS cluster:

<h3 align="center">
mongo --sslAllowInvalidHostnames --ssl --sslCAFile rds-combined-ca-bundle.pem --username xxxxxxxx --password xxxxxx --port 2701X
</h3>

<h4>MongoDB parameters:</h4>
<ul>
<li><b> sslAllowInvalidHostnames:</b> Parameter that allows validating the hostname used versus the one you want to connect to through the MongoDB server certificate.</li>
<li><b> sslCAFile:</b> Specifies the location of the public key for Amazon DocumentDB.</li>
<li><b>username:</b> DocumentDB Cluster user.</li>
<li><b>password:</b> DocumentDB Cluster password.</li>
<li><b>port:</b> Port of the Local Machine that we define manually.</li>
 </ul>
</p>
I hope I have given you a hand if you have doubts write me. successes!
